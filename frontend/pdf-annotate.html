<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annotation PDF ‚Äî ShareAzure</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs" type="module"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a1a; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; }

        /* Toolbar */
        .toolbar { display: flex; align-items: center; gap: 6px; padding: 8px 16px; background: #222; border-bottom: 1px solid #333; flex-wrap: wrap; }
        .toolbar-group { display: flex; gap: 4px; padding: 0 8px; border-right: 1px solid #444; }
        .toolbar-group:last-child { border-right: none; }
        .tool-btn { padding: 8px 12px; border: none; border-radius: 6px; background: transparent; color: #ccc; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; transition: all 0.15s; }
        .tool-btn:hover { background: #333; color: #fff; }
        .tool-btn.active { background: #1565c0; color: #fff; }
        .tool-btn.danger { color: #ef5350; }
        .tool-btn.success { color: #4caf50; }
        .file-name { color: #aaa; font-size: 0.85rem; flex: 1; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .page-nav { display: flex; align-items: center; gap: 8px; color: #aaa; font-size: 0.85rem; }
        .page-nav input { width: 40px; text-align: center; background: #333; border: 1px solid #444; border-radius: 4px; color: #fff; padding: 4px; }
        .color-picker { width: 28px; height: 28px; border: 2px solid #555; border-radius: 50%; cursor: pointer; padding: 0; }

        /* PDF Viewer */
        .viewer { flex: 1; overflow: auto; display: flex; flex-direction: column; align-items: center; padding: 20px; gap: 16px; }
        .page-wrapper { position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.5); background: #fff; }
        .page-wrapper canvas.pdf-canvas { display: block; }
        .page-wrapper canvas.annot-canvas { position: absolute; top: 0; left: 0; cursor: crosshair; }
        .page-label { text-align: center; color: #888; font-size: 0.8rem; margin-top: 4px; }

        /* Text annotations */
        .text-annotation { position: absolute; background: #fff9c4; border: 1px solid #f9a825; border-radius: 4px; padding: 4px 8px; font-size: 11px; color: #333; max-width: 200px; cursor: move; box-shadow: 0 1px 4px rgba(0,0,0,0.15); word-wrap: break-word; }
        .text-annotation .annot-author { font-size: 9px; color: #888; margin-top: 2px; }
        .text-annotation .annot-delete { position: absolute; top: -6px; right: -6px; width: 16px; height: 16px; border-radius: 50%; background: #ef5350; color: #fff; border: none; cursor: pointer; font-size: 9px; display: none; line-height: 16px; text-align: center; }
        .text-annotation:hover .annot-delete { display: block; }

        /* Sidebar annotations list */
        .sidebar { width: 300px; background: #222; border-left: 1px solid #333; display: none; flex-direction: column; overflow: hidden; }
        .sidebar.open { display: flex; }
        .sidebar-header { padding: 12px 16px; border-bottom: 1px solid #333; font-weight: 600; display: flex; justify-content: space-between; }
        .sidebar-list { flex: 1; overflow-y: auto; padding: 8px; }
        .sidebar-item { background: #2a2a2a; border-radius: 6px; padding: 8px 10px; margin-bottom: 6px; font-size: 0.8rem; cursor: pointer; }
        .sidebar-item:hover { background: #333; }
        .sidebar-item .si-page { color: #64b5f6; font-weight: 600; }
        .sidebar-item .si-author { color: #888; font-size: 0.7rem; }
        .sidebar-item .si-text { color: #ccc; margin-top: 2px; }

        @media (max-width: 768px) {
            .toolbar { padding: 6px 8px; }
            .file-name { display: none; }
            .sidebar { position: absolute; right: 0; top: 0; bottom: 0; z-index: 100; width: 280px; }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="toolbar-group">
            <button class="tool-btn" onclick="window.history.back()" title="Retour"><i class="fas fa-arrow-left"></i></button>
        </div>
        <div class="toolbar-group">
            <button class="tool-btn" id="toolSelect" onclick="setTool('select')" title="S√©lection"><i class="fas fa-mouse-pointer"></i></button>
            <button class="tool-btn" id="toolText" onclick="setTool('text')" title="Note texte"><i class="fas fa-sticky-note"></i> Note</button>
            <button class="tool-btn" id="toolHighlight" onclick="setTool('highlight')" title="Surligner"><i class="fas fa-highlighter"></i></button>
            <button class="tool-btn" id="toolDraw" onclick="setTool('draw')" title="Dessiner"><i class="fas fa-pencil-alt"></i></button>
            <button class="tool-btn" id="toolEraser" onclick="setTool('eraser')" title="Gomme"><i class="fas fa-eraser"></i></button>
        </div>
        <div class="toolbar-group">
            <input type="color" id="colorPicker" class="color-picker" value="#ff0000" title="Couleur">
            <select id="lineWidth" style="background:#333;color:#ccc;border:1px solid #444;border-radius:4px;padding:4px;">
                <option value="2">Fine</option>
                <option value="4" selected>Moyenne</option>
                <option value="8">√âpaisse</option>
            </select>
        </div>
        <span class="file-name" id="fileName"></span>
        <div class="toolbar-group">
            <div class="page-nav">
                <button class="tool-btn" onclick="goToPage(currentPage-1)"><i class="fas fa-chevron-left"></i></button>
                <input type="number" id="pageInput" value="1" min="1" onchange="goToPage(parseInt(this.value))">
                / <span id="totalPages">0</span>
                <button class="tool-btn" onclick="goToPage(currentPage+1)"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        <div class="toolbar-group">
            <button class="tool-btn" onclick="toggleSidebar()" title="Liste annotations"><i class="fas fa-list"></i></button>
            <button class="tool-btn success" onclick="saveAnnotations()" title="Sauvegarder"><i class="fas fa-save"></i> Sauvegarder</button>
            <button class="tool-btn" onclick="exportAnnotatedPDF()" title="Exporter PDF annot√©"><i class="fas fa-file-export"></i> Exporter</button>
            <button class="tool-btn danger" onclick="clearPageAnnotations()" title="Effacer page"><i class="fas fa-trash"></i></button>
        </div>
    </div>

    <div style="display:flex;flex:1;overflow:hidden;">
        <div class="viewer" id="viewer"></div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span>Annotations</span>
                <button class="tool-btn" onclick="toggleSidebar()" style="padding:4px;"><i class="fas fa-times"></i></button>
            </div>
            <div class="sidebar-list" id="sidebarList"></div>
        </div>
    </div>

    <script type="module">
    import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';

    const params = new URLSearchParams(window.location.search);
    const blobName = params.get('file');
    const token = localStorage.getItem('token');
    const API_URL = window.location.origin + '/api';
    const scale = 1.5;

    let pdfDoc = null;
    let annotations = []; // [{page_number, annotation_type, data, username, id?}]
    let currentTool = 'select';
    let isDrawing = false;
    let currentPath = [];
    let currentPage = 1;
    let pageCanvases = {}; // {pageNum: {annot: canvas, ctx: context}}
    window.currentPage = 1;

    document.getElementById('fileName').textContent = blobName ? blobName.split('/').pop() : '';

    // Load PDF
    async function loadPDF() {
        const url = `${API_URL}/preview/${encodeURIComponent(blobName)}?token=${encodeURIComponent(token)}`;
        const loadingTask = pdfjsLib.getDocument(url);
        pdfDoc = await loadingTask.promise;
        document.getElementById('totalPages').textContent = pdfDoc.numPages;
        document.getElementById('pageInput').max = pdfDoc.numPages;
        
        const viewer = document.getElementById('viewer');
        viewer.innerHTML = '';
        
        for (let i = 1; i <= pdfDoc.numPages; i++) {
            await renderPage(i, viewer);
        }
        
        // Load existing annotations
        await loadAnnotations();
    }

    async function renderPage(pageNum, container) {
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale });
        
        const wrapper = document.createElement('div');
        wrapper.className = 'page-wrapper';
        wrapper.dataset.page = pageNum;
        wrapper.style.width = viewport.width + 'px';
        wrapper.style.height = viewport.height + 'px';
        
        // PDF canvas
        const pdfCanvas = document.createElement('canvas');
        pdfCanvas.className = 'pdf-canvas';
        pdfCanvas.width = viewport.width;
        pdfCanvas.height = viewport.height;
        wrapper.appendChild(pdfCanvas);
        
        const pdfCtx = pdfCanvas.getContext('2d');
        await page.render({ canvasContext: pdfCtx, viewport }).promise;
        
        // Annotation canvas (overlay)
        const annotCanvas = document.createElement('canvas');
        annotCanvas.className = 'annot-canvas';
        annotCanvas.width = viewport.width;
        annotCanvas.height = viewport.height;
        wrapper.appendChild(annotCanvas);
        
        pageCanvases[pageNum] = { canvas: annotCanvas, ctx: annotCanvas.getContext('2d'), width: viewport.width, height: viewport.height };
        
        // Events
        annotCanvas.addEventListener('mousedown', (e) => onMouseDown(e, pageNum));
        annotCanvas.addEventListener('mousemove', (e) => onMouseMove(e, pageNum));
        annotCanvas.addEventListener('mouseup', (e) => onMouseUp(e, pageNum));
        annotCanvas.addEventListener('click', (e) => onClick(e, pageNum));
        
        // Touch support
        annotCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); onMouseDown(touchToMouse(e), pageNum); });
        annotCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); onMouseMove(touchToMouse(e), pageNum); });
        annotCanvas.addEventListener('touchend', (e) => { e.preventDefault(); onMouseUp(touchToMouse(e), pageNum); });
        
        const label = document.createElement('div');
        label.className = 'page-label';
        label.textContent = `Page ${pageNum}`;
        
        container.appendChild(wrapper);
        container.appendChild(label);
    }

    function touchToMouse(e) {
        const t = e.touches[0] || e.changedTouches[0];
        return { offsetX: t.clientX - e.target.getBoundingClientRect().left, offsetY: t.clientY - e.target.getBoundingClientRect().top };
    }

    function getRelPos(e, pageNum) {
        const pc = pageCanvases[pageNum];
        return { x: e.offsetX / pc.width, y: e.offsetY / pc.height };
    }

    // Mouse handlers
    function onMouseDown(e, pageNum) {
        if (currentTool === 'draw') {
            isDrawing = true;
            currentPath = [getRelPos(e, pageNum)];
        } else if (currentTool === 'highlight') {
            isDrawing = true;
            window._hlStart = getRelPos(e, pageNum);
        }
    }

    function onMouseMove(e, pageNum) {
        if (!isDrawing) return;
        const pc = pageCanvases[pageNum];
        if (currentTool === 'draw') {
            const pos = getRelPos(e, pageNum);
            currentPath.push(pos);
            // Live preview
            const prev = currentPath[currentPath.length - 2];
            pc.ctx.strokeStyle = document.getElementById('colorPicker').value;
            pc.ctx.lineWidth = parseInt(document.getElementById('lineWidth').value);
            pc.ctx.lineCap = 'round';
            pc.ctx.beginPath();
            pc.ctx.moveTo(prev.x * pc.width, prev.y * pc.height);
            pc.ctx.lineTo(pos.x * pc.width, pos.y * pc.height);
            pc.ctx.stroke();
        } else if (currentTool === 'highlight') {
            // Live preview highlight
            redrawPage(pageNum);
            const pos = getRelPos(e, pageNum);
            const start = window._hlStart;
            pc.ctx.fillStyle = 'rgba(255,255,0,0.35)';
            pc.ctx.fillRect(
                Math.min(start.x, pos.x) * pc.width, Math.min(start.y, pos.y) * pc.height,
                Math.abs(pos.x - start.x) * pc.width, Math.abs(pos.y - start.y) * pc.height
            );
        }
    }

    function onMouseUp(e, pageNum) {
        if (!isDrawing) return;
        isDrawing = false;
        const color = document.getElementById('colorPicker').value;
        const hexToRgb = (h) => [parseInt(h.slice(1,3),16)/255, parseInt(h.slice(3,5),16)/255, parseInt(h.slice(5,7),16)/255];
        
        if (currentTool === 'draw' && currentPath.length > 1) {
            annotations.push({
                page_number: pageNum,
                annotation_type: 'drawing',
                data: { paths: [currentPath], color: hexToRgb(color), lineWidth: parseInt(document.getElementById('lineWidth').value) },
                username: 'moi', _local: true
            });
            currentPath = [];
        } else if (currentTool === 'highlight' && window._hlStart) {
            const end = getRelPos(e, pageNum);
            const start = window._hlStart;
            annotations.push({
                page_number: pageNum,
                annotation_type: 'highlight',
                data: { x: Math.min(start.x, end.x), y: Math.min(start.y, end.y), w: Math.abs(end.x - start.x), h: Math.abs(end.y - start.y) },
                username: 'moi', _local: true
            });
            window._hlStart = null;
        }
        redrawPage(pageNum);
        updateSidebar();
    }

    function onClick(e, pageNum) {
        if (currentTool === 'text') {
            const pos = getRelPos(e, pageNum);
            const text = prompt('Votre annotation :');
            if (!text) return;
            annotations.push({
                page_number: pageNum,
                annotation_type: 'text',
                data: { x: pos.x, y: pos.y, text },
                username: 'moi', _local: true
            });
            redrawPage(pageNum);
            updateSidebar();
        } else if (currentTool === 'eraser') {
            // Remove nearest annotation on this page
            const pos = getRelPos(e, pageNum);
            let closest = -1, minDist = 0.05;
            annotations.forEach((a, i) => {
                if (a.page_number !== pageNum) return;
                let dist;
                if (a.annotation_type === 'text') dist = Math.hypot(a.data.x - pos.x, a.data.y - pos.y);
                else if (a.annotation_type === 'highlight') dist = Math.hypot((a.data.x + a.data.w/2) - pos.x, (a.data.y + a.data.h/2) - pos.y);
                else if (a.annotation_type === 'drawing' && a.data.paths?.[0]) {
                    const mid = a.data.paths[0][Math.floor(a.data.paths[0].length/2)];
                    dist = Math.hypot(mid.x - pos.x, mid.y - pos.y);
                }
                if (dist !== undefined && dist < minDist) { minDist = dist; closest = i; }
            });
            if (closest >= 0) {
                annotations.splice(closest, 1);
                redrawPage(pageNum);
                updateSidebar();
            }
        }
    }

    // Redraw annotations for a page
    function redrawPage(pageNum) {
        const pc = pageCanvases[pageNum];
        if (!pc) return;
        pc.ctx.clearRect(0, 0, pc.width, pc.height);
        
        // Remove old text annotations
        const wrapper = pc.canvas.parentElement;
        wrapper.querySelectorAll('.text-annotation').forEach(el => el.remove());
        
        for (const a of annotations) {
            if (a.page_number !== pageNum) continue;
            
            if (a.annotation_type === 'drawing' && a.data.paths) {
                for (const path of a.data.paths) {
                    if (path.length < 2) continue;
                    pc.ctx.strokeStyle = a.data.color ? `rgb(${a.data.color.map(c=>Math.round(c*255)).join(',')})` : '#ff0000';
                    pc.ctx.lineWidth = a.data.lineWidth || 2;
                    pc.ctx.lineCap = 'round';
                    pc.ctx.beginPath();
                    pc.ctx.moveTo(path[0].x * pc.width, path[0].y * pc.height);
                    for (let i = 1; i < path.length; i++) {
                        pc.ctx.lineTo(path[i].x * pc.width, path[i].y * pc.height);
                    }
                    pc.ctx.stroke();
                }
            } else if (a.annotation_type === 'highlight') {
                pc.ctx.fillStyle = 'rgba(255,255,0,0.35)';
                pc.ctx.fillRect(a.data.x * pc.width, a.data.y * pc.height, (a.data.w||0.1) * pc.width, (a.data.h||0.02) * pc.height);
            } else if (a.annotation_type === 'text') {
                const div = document.createElement('div');
                div.className = 'text-annotation';
                div.style.left = (a.data.x * pc.width) + 'px';
                div.style.top = (a.data.y * pc.height) + 'px';
                div.innerHTML = `${a.data.text}<div class="annot-author">${a.username}</div>`;
                const delBtn = document.createElement('button');
                delBtn.className = 'annot-delete';
                delBtn.textContent = '‚úï';
                delBtn.onclick = () => {
                    const idx = annotations.indexOf(a);
                    if (idx >= 0) { annotations.splice(idx, 1); redrawPage(pageNum); updateSidebar(); }
                };
                div.appendChild(delBtn);
                wrapper.appendChild(div);
            }
        }
    }

    // Load existing annotations from server
    async function loadAnnotations() {
        try {
            const res = await fetch(`${API_URL}/files/${encodeURIComponent(blobName)}/annotations`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            if (data.success) {
                annotations = data.annotations.map(a => ({
                    ...a,
                    data: JSON.parse(a.data)
                }));
                // Redraw all pages
                for (const pageNum in pageCanvases) {
                    redrawPage(parseInt(pageNum));
                }
                updateSidebar();
            }
        } catch (e) { console.error('Load annotations error:', e); }
    }

    // Save
    window.saveAnnotations = async () => {
        const localAnnots = annotations.filter(a => a._local);
        if (localAnnots.length === 0) { alert('Rien √† sauvegarder'); return; }
        try {
            const res = await fetch(`${API_URL}/files/${encodeURIComponent(blobName)}/annotations`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ annotations: localAnnots })
            });
            const data = await res.json();
            if (data.success) {
                // Mark as saved
                annotations.forEach(a => delete a._local);
                alert(`${data.count} annotations sauvegard√©es !`);
            }
        } catch (e) { alert('Erreur: ' + e.message); }
    };

    // Export annotated PDF
    window.exportAnnotatedPDF = async () => {
        // Save first
        const localAnnots = annotations.filter(a => a._local);
        if (localAnnots.length > 0) {
            await fetch(`${API_URL}/files/${encodeURIComponent(blobName)}/annotations`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ annotations: localAnnots })
            });
            annotations.forEach(a => delete a._local);
        }
        // Download
        const link = document.createElement('a');
        link.href = `${API_URL}/files/${encodeURIComponent(blobName)}/annotations/export?token=${encodeURIComponent(token)}`;
        link.download = `annotated_${blobName.split('/').pop()}`;
        // Use fetch for auth
        const res = await fetch(link.href, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }});
        const blob = await res.blob();
        link.href = URL.createObjectURL(blob);
        link.click();
    };

    // Clear page
    window.clearPageAnnotations = () => {
        const pageNum = currentPage;
        if (!confirm(`Effacer toutes les annotations de la page ${pageNum} ?`)) return;
        annotations = annotations.filter(a => a.page_number !== pageNum);
        redrawPage(pageNum);
        updateSidebar();
    };

    // Tool selection
    window.setTool = (tool) => {
        currentTool = tool;
        document.querySelectorAll('.tool-btn[id^="tool"]').forEach(b => b.classList.remove('active'));
        document.getElementById('tool' + tool.charAt(0).toUpperCase() + tool.slice(1))?.classList.add('active');
        // Update cursor
        for (const pc of Object.values(pageCanvases)) {
            pc.canvas.style.cursor = tool === 'select' ? 'default' : tool === 'eraser' ? 'not-allowed' : 'crosshair';
        }
    };

    // Page navigation
    window.goToPage = (num) => {
        if (!pdfDoc || num < 1 || num > pdfDoc.numPages) return;
        currentPage = num;
        window.currentPage = num;
        document.getElementById('pageInput').value = num;
        const wrapper = document.querySelector(`.page-wrapper[data-page="${num}"]`);
        if (wrapper) wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    // Sidebar
    window.toggleSidebar = () => {
        document.getElementById('sidebar').classList.toggle('open');
        updateSidebar();
    };

    function updateSidebar() {
        const list = document.getElementById('sidebarList');
        if (!list) return;
        if (annotations.length === 0) {
            list.innerHTML = '<div style="color:#666;text-align:center;padding:20px;">Aucune annotation</div>';
            return;
        }
        list.innerHTML = annotations.map((a, i) => {
            const typeIcons = { text: 'üìù', highlight: 'üü°', drawing: '‚úèÔ∏è' };
            const preview = a.annotation_type === 'text' ? a.data.text.substring(0, 40) : a.annotation_type;
            return `<div class="sidebar-item" onclick="goToPage(${a.page_number})">
                <span class="si-page">${typeIcons[a.annotation_type] || '?'} Page ${a.page_number}</span>
                <span class="si-author"> ‚Äî ${a.username}${a._local ? ' (non sauv√©)' : ''}</span>
                <div class="si-text">${preview}</div>
            </div>`;
        }).join('');
    }

    // Detect page scroll
    const viewer = document.getElementById('viewer');
    viewer.addEventListener('scroll', () => {
        const wrappers = document.querySelectorAll('.page-wrapper');
        const viewerRect = viewer.getBoundingClientRect();
        const center = viewerRect.top + viewerRect.height / 2;
        for (const w of wrappers) {
            const r = w.getBoundingClientRect();
            if (r.top <= center && r.bottom >= center) {
                const p = parseInt(w.dataset.page);
                if (p !== currentPage) {
                    currentPage = p;
                    window.currentPage = p;
                    document.getElementById('pageInput').value = p;
                }
                break;
            }
        }
    });

    // Init
    setTool('select');
    if (blobName) loadPDF();
    else document.getElementById('viewer').innerHTML = '<p style="color:#999;padding:40px;">Aucun fichier s√©lectionn√©. Utilisez ?file=chemin/vers/fichier.pdf</p>';
    </script>
</body>
</html>
